variables:
  - name: _TeamName
    value: DotNetCore
  - name: _PublishUsingPipelines
    value: true
  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - group: SDL_Settings
  - ${{ if and(eq(variables.PoolProvider, ''), eq(variables['System.TeamProject'], 'public')) }}:
    - name: PoolProvider
      value: NetCorePublic-Pool
  - ${{ if and(ne(variables.PoolProvider, ''), ne(variables['System.TeamProject'], 'public')) }}:
    - name: PoolProvider
      value: NetCoreInternal-Pool
  - ${{ if and(eq(variables['System.TeamProject'], 'public'), in(variables['Build.Reason'], 'Schedule')) }}:
    - name: PoolProvider
      value: NetCorePublic-Int-Pool
  - ${{ if and(ne(variables['System.TeamProject'], 'public'), in(variables['Build.Reason'], 'Schedule')) }}:
    - name: PoolProvider
      value: NetCoreInternal-Int-Pool

trigger:
  batch: true
  branches:
    include:
      - master
      - release/3.x
pr:
  branches:
    include:
    - '*'

schedules:
- cron: "0 0 * * *"
  displayName: Once a day build using Staging pools (at midnight)
  branches:
    include:
    - master
  always: true

resources:
  containers:
  - container: LinuxContainer
    image: microsoft/dotnet-buildtools-prereqs:ubuntu-14.04-cross-0cd4667-20170319080304

stages:
  - stage: Validate_Arcade_With_Consumer_Repositories
    displayName: Validate Arcade with Consumer Repositories
    jobs:
      - template: /eng/common/templates/job/job.yml
        parameters:
          name: Validate_Arcade_With_Consumer_Repositories
          displayName: Validate Arcade with Consumer Repositories
          timeoutInMinutes: 240
          variables:
            - group: Publish-Build-Assets
            - group: DotNetBot-GitHub
            - group: DotNet-Blob-Feed
            - group: DotNet-Symbol-Server-Pats
            - group: DotNet-VSTS-Infra-Access
          strategy:
            matrix:
              ValidateWithRuntime:
                _azdoOrg: "dnceng"
                _azdoProject: "internal"
                _buildDefinitionId: 679
                _githubRepoName: "runtime"
                _azdoToken: $(dn-bot-dnceng-build-rw-code-rw)
                _optionalParameters: "-azdoRepoName 'dotnet-runtime' -subscribedBranchName 'master'"
              ValidateWithASPNETCore:
                _azdoOrg: "dnceng"
                _azdoProject: "internal"
                _buildDefinitionId: 21
                _githubRepoName: "aspnetcore"
                _azdoToken: $(dn-bot-dnceng-build-rw-code-rw)
                _optionalParameters: "-azdoRepoName 'dotnet-aspnetcore' -subscribedBranchName 'master'"
          steps:
            - checkout: self
              clean: true
            - powershell: eng\validation\build-arcadewithrepo.ps1
                -azdoOrg $(_azdoOrg)
                -azdoProject $(_azdoProject)
                -buildDefinitionId $(_buildDefinitionId)
                -azdoToken $(_azdoToken)
                -githubUser "dotnet-bot"
                -githubPAT $(BotAccount-dotnet-bot-repo-PAT)
                -githubOrg "dotnet"
                -githubRepoName $(_githubRepoName)
                -barToken $(MaestroAccessToken)
                $(_optionalParameters)
              continueOnError: true
            - powershell: |
                write-host 'arcadeVersion is ' $(arcadeVersion)
              condition: always()