variables:
  - name: _TeamName
    value: DotNetCore
  - name: _PublishUsingPipelines
    value: true
  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - group: AzureDevOps-Artifact-Feeds-Pats
    - group: SDL_Settings
  - ${{ if and(eq(variables.PoolProvider, ''), eq(variables['System.TeamProject'], 'public')) }}:
    - name: PoolProvider
      value: NetCorePublic-Pool
  - ${{ if and(ne(variables.PoolProvider, ''), ne(variables['System.TeamProject'], 'public')) }}:
    - name: PoolProvider
      value: NetCoreInternal-Pool
  - ${{ if and(eq(variables['System.TeamProject'], 'public'), in(variables['Build.Reason'], 'Schedule')) }}:
    - name: PoolProvider
      value: NetCorePublic-Int-Pool
  - ${{ if and(ne(variables['System.TeamProject'], 'public'), in(variables['Build.Reason'], 'Schedule')) }}:
    - name: PoolProvider
      value: NetCoreInternal-Int-Pool

trigger:
  batch: true
  branches:
    include:
      - master
      - release/3.x
pr:
  branches:
    include:
    - '*'

schedules:
- cron: "0 0 * * *"
  displayName: Once a day build using Staging pools (at midnight)
  branches:
    include:
    - master
  always: true

resources:
  containers:
  - container: LinuxContainer
    image: microsoft/dotnet-buildtools-prereqs:ubuntu-14.04-cross-0cd4667-20170319080304

stages:


- ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
  - template: eng\common\templates\post-build\post-build.yml
    parameters:
      publishingInfraVersion: 3
      # Symbol validation isn't being very reliable lately. This should be enabled back
      # once this issue is resolved: https://github.com/dotnet/arcade/issues/2871
      enableSymbolValidation: false
      # Sourcelink validation isn't passing for Arcade-validation. This should be
      # enabled back once this issue is resolved: https://github.com/dotnet/arcade/issues/3069
      enableSourceLinkValidation: false
      # This is to enable SDL runs part of Post-Build Validation Stage
      SDLValidationParameters:
        enable: true
        params: ' -SourceToolsList @("policheck","credscan")
        -TsaInstanceURL $(_TsaInstanceURL)
        -TsaProjectName $(_TsaProjectName)
        -TsaNotificationEmail $(_TsaNotificationEmail)
        -TsaCodebaseAdmin $(_TsaCodebaseAdmin)
        -TsaBugAreaPath $(_TsaBugAreaPath)
        -TsaIterationPath $(_TsaIterationPath)
        -TsaRepositoryName "Arcade-Validation"
        -TsaCodebaseName "Arcade-Validation"
        -TsaPublish $True'
  - stage: Validate_Publishing
    displayName: Validate Publishing
    jobs: 
    - template: /eng/common/templates/post-build/setup-maestro-vars.yml
    - template: /eng/common/templates/job/job.yml
      parameters:
        name: Validate_Publishing
        displayName: Validate Publishing
        dependsOn: setupMaestroVars
        timeoutInMinutes: 240
        pool: 
          vmImage: vs2017-win2016
        variables:
          - group: Publish-Build-Assets
          - group: DotNetBot-GitHub
          - name: BARBuildId
            value: $[ dependencies.setupMaestroVars.outputs['setReleaseVars.BARBuildId'] ]
        steps:
          - checkout: self
            clean: true
          - powershell: eng\validation\test-publishing.ps1
              -buildId $(BARBuildId)
              -azdoToken $(dn-bot-dotnet-build-rw-code-rw)
              -azdoUser "dotnet-bot"
              -azdoOrg "dnceng"
              -azdoProject "internal"
              -barToken $(MaestroAccessToken)
              -githubPAT $(BotAccount-dotnet-bot-repo-PAT)  
  - stage: Promote_Arcade_To_Latest
    displayName: Promote Arcade to '.NET Eng - Latest' channel
    dependsOn:
      - Validate_Publishing
    jobs:
    - template: /eng/common/templates/job/job.yml
      parameters:
        name: Promote_Arcade_To_Latest
        displayName: Promote Arcade to '.NET Eng - Latest' channel
        timeoutInMinutes: 180
        variables: 
          - group: Publish-Build-Assets
          - group: DotNetBot-GitHub
        steps: 
          - checkout: self
            clean: True
          - powershell: eng/validation/update-channel.ps1
                  -barToken $(MaestroAccessToken)
                  -azdoToken $(dn-bot-dnceng-build-rw-code-rw)
                  -githubToken $(BotAccount-dotnet-bot-repo-PAT)
            displayName: Promote Arcade to 'Latest' channel 

